# üîê GUIDE DE CONFIGURATION GOOGLE OAUTH - SGDI

## üìã Vue d'ensemble

Ce guide vous accompagne **√©tape par √©tape** pour configurer l'authentification Google OAuth dans le SGDI.

**Dur√©e estim√©e** : 10-15 minutes

---

## ‚úÖ Pr√©requis

- [ ] Un compte Google (Gmail)
- [ ] Acc√®s √† Internet
- [ ] Le SGDI install√© et fonctionnel

---

## üöÄ √âTAPE 1 : Acc√©der √† Google Cloud Console

### 1.1 Ouvrir la console
1. Aller sur : **https://console.cloud.google.com/**
2. Se connecter avec votre compte Google

![Google Cloud Console](https://i.imgur.com/console-home.png)

### 1.2 V√©rifier/Cr√©er une organisation (Optionnel)
- Si vous avez d√©j√† une organisation : Passer √† l'√©tape 2
- Sinon : Suivre les instructions de Google pour cr√©er une organisation

---

## üèóÔ∏è √âTAPE 2 : Cr√©er un Nouveau Projet

### 2.1 Cliquer sur le s√©lecteur de projet
En haut √† gauche, √† c√¥t√© de "Google Cloud Platform", cliquer sur le **s√©lecteur de projet**

### 2.2 Cr√©er un nouveau projet
1. Cliquer sur **"NOUVEAU PROJET"** (en haut √† droite)
2. Remplir les informations :
   ```
   Nom du projet    : SGDI-MINEE
   Organisation     : (Votre organisation ou laisser vide)
   Emplacement      : (Laisser par d√©faut)
   ```
3. Cliquer sur **"CR√âER"**
4. Attendre la cr√©ation (quelques secondes)
5. S√©lectionner le projet nouvellement cr√©√©

![Cr√©er projet](https://i.imgur.com/create-project.png)

---

## üîå √âTAPE 3 : Activer les APIs N√©cessaires

### 3.1 Acc√©der √† la biblioth√®que d'API
1. Dans le menu de gauche, cliquer sur **"APIs et services"**
2. Cliquer sur **"Biblioth√®que"**

### 3.2 Activer Google+ API
1. Dans la barre de recherche, taper : **"Google+ API"**
2. Cliquer sur **"Google+ API"** dans les r√©sultats
3. Cliquer sur **"ACTIVER"**
4. Attendre l'activation (quelques secondes)

### 3.3 Activer People API (recommand√©)
1. Retourner √† la biblioth√®que
2. Rechercher : **"Google People API"**
3. Cliquer sur **"Google People API"**
4. Cliquer sur **"ACTIVER"**

![Activer API](https://i.imgur.com/enable-api.png)

---

## üîë √âTAPE 4 : Cr√©er les Identifiants OAuth 2.0

### 4.1 Acc√©der aux identifiants
1. Dans le menu de gauche : **"APIs et services"** ‚Üí **"Identifiants"**
2. Cliquer sur **"+ CR√âER DES IDENTIFIANTS"** (en haut)
3. S√©lectionner **"ID client OAuth"**

### 4.2 Configurer l'√©cran de consentement OAuth (si demand√©)

#### Si c'est votre premi√®re fois :
1. Cliquer sur **"CONFIGURER L'√âCRAN DE CONSENTEMENT"**

#### Type d'utilisateur :
- S√©lectionner **"Externe"** (pour permettre tout compte Gmail)
- Cliquer sur **"CR√âER"**

#### Informations sur l'application :
```
Nom de l'application          : SGDI - Registre Public
E-mail d'assistance utilisateur : votre-email@gmail.com
Logo de l'application          : (Optionnel)
```

#### Domaine de l'application :
```
Domaine de l'application      : localhost (ou votre domaine)
Lien vers les r√®gles de confidentialit√© : (Optionnel)
Lien vers les conditions d'utilisation  : (Optionnel)
```

#### Coordonn√©es du d√©veloppeur :
```
Adresses e-mail : votre-email@gmail.com
```

3. Cliquer sur **"ENREGISTRER ET CONTINUER"**

#### Champs d'application (Scopes) :
1. Cliquer sur **"AJOUTER OU SUPPRIMER DES CHAMPS D'APPLICATION"**
2. Cocher :
   - ‚òëÔ∏è `.../auth/userinfo.email`
   - ‚òëÔ∏è `.../auth/userinfo.profile`
   - ‚òëÔ∏è `openid`
3. Cliquer sur **"METTRE √Ä JOUR"**
4. Cliquer sur **"ENREGISTRER ET CONTINUER"**

#### Utilisateurs de test (Mode d√©veloppement) :
1. Cliquer sur **"+ AJOUTER DES UTILISATEURS"**
2. Ajouter votre adresse Gmail pour les tests
3. Cliquer sur **"AJOUTER"**
4. Cliquer sur **"ENREGISTRER ET CONTINUER"**

5. V√©rifier le r√©sum√© et cliquer sur **"RETOUR AU TABLEAU DE BORD"**

### 4.3 Cr√©er l'ID client OAuth

1. Retourner dans **"Identifiants"**
2. Cliquer sur **"+ CR√âER DES IDENTIFIANTS"**
3. S√©lectionner **"ID client OAuth"**

#### Type d'application :
- S√©lectionner **"Application Web"**

#### Nom :
```
Nom : SGDI Lecteur Public
```

#### Origines JavaScript autoris√©es :
Cliquer sur **"+ AJOUTER UN URI"** et ajouter :
```
http://localhost
http://127.0.0.1
```

Si vous avez un domaine de production :
```
https://votre-domaine.com
```

#### URI de redirection autoris√©s :
Cliquer sur **"+ AJOUTER UN URI"** et ajouter :

**Pour d√©veloppement local** :
```
http://localhost/dppg-implantation/auth/google_callback.php
http://127.0.0.1/dppg-implantation/auth/google_callback.php
```

**Pour WAMP (si port diff√©rent)** :
```
http://localhost:8080/dppg-implantation/auth/google_callback.php
```

**Pour production** :
```
https://votre-domaine.com/auth/google_callback.php
```

‚ö†Ô∏è **IMPORTANT** : L'URI doit √™tre **EXACTEMENT** le m√™me que celui configur√© dans votre code !

4. Cliquer sur **"CR√âER"**

### 4.4 R√©cup√©rer les identifiants

Une fen√™tre s'affiche avec :
```
ID client OAuth     : 123456789-abc123def456.apps.googleusercontent.com
Secret du client    : GOCSPX-abc123def456ghi789
```

üìã **COPIER CES DEUX VALEURS** - Vous en aurez besoin √† l'√©tape suivante !

Vous pouvez aussi les retrouver en cliquant sur l'ID client cr√©√© dans la liste.

![Identifiants OAuth](https://i.imgur.com/oauth-credentials.png)

---

## ‚öôÔ∏è √âTAPE 5 : Configurer le Code SGDI

### 5.1 Ouvrir le fichier de configuration
Ouvrir le fichier : **`config/google_oauth.php`**

### 5.2 Remplacer les valeurs
Localiser ces lignes (lignes 11-12) :
```php
define('GOOGLE_CLIENT_ID', 'VOTRE_CLIENT_ID.apps.googleusercontent.com');
define('GOOGLE_CLIENT_SECRET', 'VOTRE_CLIENT_SECRET');
```

Remplacer par vos vraies valeurs :
```php
define('GOOGLE_CLIENT_ID', '123456789-abc123def456.apps.googleusercontent.com');
define('GOOGLE_CLIENT_SECRET', 'GOCSPX-abc123def456ghi789');
```

### 5.3 V√©rifier l'URI de redirection
Localiser la ligne 13 :
```php
define('GOOGLE_REDIRECT_URI', BASE_URL . '/auth/google_callback.php');
```

S'assurer que `BASE_URL` est correctement d√©fini dans `config/config.php` :
```php
// Exemple pour WAMP en local
define('BASE_URL', 'http://localhost/dppg-implantation');

// Exemple pour production
define('BASE_URL', 'https://votre-domaine.com');
```

### 5.4 Sauvegarder le fichier
Enregistrer les modifications dans `config/google_oauth.php`

---

## üß™ √âTAPE 6 : Tester la Connexion

### 6.1 Acc√©der √† la page de connexion
1. Ouvrir un navigateur
2. Aller sur : **http://localhost/dppg-implantation/**
3. Vous devriez voir le bouton **"Se connecter avec Google"**

### 6.2 Tester l'authentification
1. Cliquer sur **"Se connecter avec Google"**
2. S√©lectionner votre compte Google
3. Autoriser l'application SGDI √† acc√©der √† :
   - Votre adresse e-mail
   - Vos informations de profil
4. Cliquer sur **"Autoriser"**

### 6.3 V√©rifier la redirection
Vous devriez √™tre redirig√© vers :
```
http://localhost/dppg-implantation/modules/lecteur/dashboard.php
```

Avec le message : **"Bienvenue [Pr√©nom] ! Vous √™tes connect√© avec Google."**

### 6.4 V√©rifier le compte cr√©√©
1. Se d√©connecter
2. Se reconnecter avec le compte admin (`admin` / `admin123`)
3. Aller dans **Gestion des utilisateurs**
4. V√©rifier qu'un nouveau compte lecteur a √©t√© cr√©√© avec :
   - Username : `prenom_nom_xxxx`
   - Email : Votre Gmail
   - R√¥le : lecteur
   - Photo : Photo de profil Google

---

## üêõ D√âPANNAGE

### Probl√®me 1 : "Erreur 400: redirect_uri_mismatch"

**Cause** : L'URI de redirection ne correspond pas

**Solution** :
1. V√©rifier dans Google Cloud Console ‚Üí Identifiants ‚Üí Votre ID client
2. Comparer l'URI de redirection configur√©e avec celle dans le code
3. S'assurer qu'elles sont **EXACTEMENT** identiques (majuscules/minuscules, slash final, etc.)

**Exemple d'erreur** :
```
Configur√© dans Google : http://localhost/dppg-implantation/auth/google_callback.php
Dans le code           : http://localhost/dppg-implantation/auth/google_callback.php/
                                                                                      ^ Slash en trop !
```

### Probl√®me 2 : "Erreur 403: access_denied"

**Cause** : L'utilisateur n'est pas dans la liste des testeurs (mode d√©veloppement)

**Solution** :
1. Aller dans Google Cloud Console
2. APIs et services ‚Üí √âcran de consentement OAuth
3. Section "Utilisateurs de test"
4. Ajouter l'adresse Gmail de test
5. R√©essayer

### Probl√®me 3 : "Erreur d'authentification Google: Aucun code re√ßu"

**Cause** : L'utilisateur a refus√© l'autorisation

**Solution** :
1. R√©essayer la connexion
2. Cliquer sur **"Autoriser"** quand Google demande les permissions

### Probl√®me 4 : "Impossible d'obtenir le token"

**Cause** : Client ID ou Client Secret incorrect

**Solution** :
1. V√©rifier les valeurs dans `config/google_oauth.php`
2. Comparer avec Google Cloud Console ‚Üí Identifiants
3. Copier-coller √† nouveau (attention aux espaces)

### Probl√®me 5 : "cURL error" ou "SSL certificate problem"

**Cause** : Probl√®me de certificat SSL (WAMP/Windows)

**Solution temporaire** (d√©veloppement uniquement) :
Dans `config/google_oauth.php`, localiser :
```php
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
```
Cette ligne d√©sactive la v√©rification SSL (d√©j√† pr√©sente)

**Solution d√©finitive** (production) :
1. T√©l√©charger le certificat CA : https://curl.se/ca/cacert.pem
2. Sauvegarder dans `C:\wamp64\bin\php\php8.x\extras\ssl\`
3. Modifier `php.ini` :
   ```ini
   curl.cainfo = "C:\wamp64\bin\php\php8.x\extras\ssl\cacert.pem"
   ```
4. Red√©marrer Apache

### Probl√®me 6 : Page blanche apr√®s autorisation

**Cause** : Erreur PHP non affich√©e

**Solution** :
1. Activer l'affichage des erreurs dans `php.ini` :
   ```ini
   display_errors = On
   error_reporting = E_ALL
   ```
2. Red√©marrer Apache
3. Consulter les logs PHP : `C:\wamp64\logs\php_error.log`
4. V√©rifier les logs Apache : `C:\wamp64\logs\apache_error.log`

### Probl√®me 7 : "Ce compte n'est pas un compte lecteur"

**Cause** : L'email Google correspond √† un utilisateur existant avec un autre r√¥le

**Solution** :
1. Utiliser une autre adresse Gmail
2. OU demander √† l'admin de supprimer/modifier l'utilisateur existant
3. OU utiliser le mot de passe classique pour ce compte

---

## üìä V√âRIFICATION DE L'INSTALLATION

### Checklist finale

- [ ] Projet cr√©√© dans Google Cloud Console
- [ ] Google+ API activ√©e
- [ ] √âcran de consentement configur√©
- [ ] ID client OAuth cr√©√©
- [ ] URI de redirection ajout√©
- [ ] Client ID copi√© dans `config/google_oauth.php`
- [ ] Client Secret copi√© dans `config/google_oauth.php`
- [ ] BASE_URL correctement d√©fini
- [ ] Bouton Google visible sur page de connexion
- [ ] Test de connexion r√©ussi
- [ ] Compte lecteur cr√©√© automatiquement
- [ ] Redirection vers dashboard lecteur OK

---

## üîí S√âCURIT√â

### Pour le d√©veloppement (localhost)
- ‚úÖ HTTP accept√©
- ‚úÖ SSL verification disabled (dans le code)
- ‚úÖ Mode "Externe" pour tout compte Gmail

### Pour la production
- ‚ö†Ô∏è **OBLIGATOIRE** : Utiliser HTTPS uniquement
- ‚ö†Ô∏è Activer SSL verification :
  ```php
  curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
  ```
- ‚ö†Ô∏è Publier l'application (sortir du mode test)
- ‚ö†Ô∏è Ajouter vraie politique de confidentialit√©
- ‚ö†Ô∏è Configurer le domaine v√©rifi√©

---

## üì± PASSAGE EN PRODUCTION

### 1. Publier l'application
1. Google Cloud Console ‚Üí APIs et services ‚Üí √âcran de consentement OAuth
2. Cliquer sur **"PUBLIER L'APPLICATION"**
3. Google peut demander une v√©rification (si > 100 utilisateurs)

### 2. Mettre √† jour les URIs
1. Ajouter les URIs de production :
   ```
   https://votre-domaine.com
   https://votre-domaine.com/auth/google_callback.php
   ```
2. Retirer les URIs localhost si souhait√©

### 3. Mettre √† jour le code
1. Modifier `config/config.php` :
   ```php
   define('BASE_URL', 'https://votre-domaine.com');
   ```
2. Activer SSL verification dans `config/google_oauth.php` :
   ```php
   curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
   ```

---

## üìö RESSOURCES

### Documentation officielle
- **Google OAuth 2.0** : https://developers.google.com/identity/protocols/oauth2
- **Google Cloud Console** : https://console.cloud.google.com/
- **People API** : https://developers.google.com/people

### Support
- **Documentation SGDI** : `/docs`
- **Email** : support@sgdi.minee.cm

---

## ‚úÖ R√âSUM√â

Vous avez maintenant configur√© avec succ√®s l'authentification Google OAuth !

**Les utilisateurs peuvent** :
- ‚úÖ Se connecter avec leur compte Gmail en 1 clic
- ‚úÖ Acc√©der au registre public sans cr√©er de mot de passe
- ‚úÖ Voir leur photo de profil Google

**Le syst√®me** :
- ‚úÖ Cr√©e automatiquement un compte lecteur
- ‚úÖ Enregistre l'email et le nom de l'utilisateur
- ‚úÖ Redirige vers le dashboard lecteur
- ‚úÖ Log toutes les connexions

---

**Derni√®re mise √† jour** : 5 Janvier 2025
**Version** : 1.0
**Statut** : ‚úÖ Pr√™t pour production
